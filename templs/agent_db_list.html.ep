%#
%# $Id$
%#
% layout 'default';
% title 'Dumper';
% use Mojo::Util qw(dumper);


% my $m = $self->app->model;

% my $agent_id = $req->param('id');
% my $agent_hostname = $m->agent_hostname($agent_id);

% my $agent_alive = $m->agent_alive($agent_id);
% unless ($agent_alive) {
    <div class="callout alert">
        Oops...Agent <%= $agent_hostname %> not responded.
        Use cached database list.
    </div>
% }

% if ($agent_alive) {
%    my $res = $m->agent_db_update($agent_id);
%    unless ($res) {
       <div class="callout alert">
          Oops...Agent <%= $agent_hostname %> not responded for update db list.
          Use cached database list.
      </div>
%    }
% }

% my $dbList = $m->agent_db_list($agent_id);
% my $store_list = $m->store_list;

% my $num = 1;
% foreach my $db (@{$dbList}) {
%   my $dbname = $db->{'name'};
%   my $dbsize = $db->{'size'};
%   my $dbowner = $db->{'owner'};

%#  --- dump database ---
    <div class="reveal" id="modal-dump-<%= $dbname %>" data-reveal>
        <div class="text-center">
            <h5>Dump database <%= $dbname %> from <%= $agent_hostname %></h5>
        </div>
        <form accept-charset="UTF-8" action="/agent/db/dump" method="get" data-abide novalidate>
            <input type="hidden" name="agentid" value="<%= $agent_id %>" />
            <input type="hidden" name="dbname" value="<%= $dbname %>" />

            <label>Store hostname
                <select name="storeid" id="store-hostname" required>
                    <option value=""></option>
%                   foreach my $store (@{$store_list}) {
%                      my $storeName = $store->{'hostname'};
%                      my $store_id = $store->{'id'};
                       <option value="<%= $store_id %>"><%= $storeName %></option>
%                   }
                </select>
            </label>
            <p class="text-center">
                <button type="submit" class="button success">Accept</button>
                <button class="button" data-close="modal-dump-<%= $dbname %>" type="button">Escape</button>
            </p>
        </form>
        <button class="close-button" data-close="modal-dump-<%= $dbname %>" type="button">&times;</button>
    </div>


%#  --- schedule of dump database ---
    <div class="reveal" id="modal-schedule-<%= $dbname %>" data-reveal>
        <div class="text-center">
            <h5>Add dump schedule <%= $dbname %></h5>
        </div>

        <form accept-charset="UTF-8" action="/schedule/add" method="get" data-abide novalidate>
            <input type="hidden" name="type" value="dump" />
            <input type="hidden" name="sourceid" value="<%= $agent_id %>" />
            <input type="hidden" name="subject" value="<%= $dbname %>" />

            <label>Store hostname
                <select name="destid" required>
                    <option value=""></option>
%                   foreach my $store (@{$store_list}) {
%                      my $storeName = $store->{'hostname'};
%                      my $store_id = $store->{'id'};
                       <option value="<%= $store_id %>"><%= $storeName %></option>
%                   }
                </select>
            </label>

            <label>Day of month
                <input type="text" name="mday" value="1-31" placeholder="1-31" required pattern="[0-9\-;.,/*]{1,64}"/>
                <span class="form-error">mandatory, 1 or more letter, like 23,15-18</span>
            </label>

            <label>Day of week
                <input type="text" name="wday" value="1-7" placeholder="1-7" required pattern="[0-9\-,;./*]{1,64}"/>
                <span class="form-error">mandatory, 1 or more letter</span>
            </label>

            <label>Hour
                <input type="text" name="hour" value="6,23" placeholder="" required pattern="[0-9\-,;./*]{1,64}"/>
                <span class="form-error">mandatory, 1 or more letter</span>
            </label>

            <label>Min
                <input type="text" name="min" value="10" placeholder="" required pattern="[0-9\-,;./*]{1,64}"/>
                <span class="form-error">mandatory, 1 or more letter</span>
            </label>

            <p class="text-center">
                <button type="submit" class="button success">Accept</button>
                <button class="button" data-close="modal-schedule-<%= $dbname %>" type="button">Escape</button>
            </p>
        </form>
        <button class="close-button" data-close="modal-schedule-<%= $dbname %>" type="button">&times;</button>
    </div>


%#  --- drop database ---
    <div class="reveal" id="modal-drop-<%= $dbname %>" data-reveal>
        <div class="text-center">
            <h5>Drop database <%= $dbname %> on <%= $agent_hostname %> </h5>
        </div>
        <form accept-charset="UTF-8" action="/agent/db/drop" method="get" data-abide novalidate>
            <input type="hidden" name="agentid" value="<%= $agent_id %>" />
            <input type="hidden" name="dbname" value="<%= $dbname %>" />
            <p class="text-center">
                <button type="submit" class="button alert">Accept</button>
                <button class="button" data-close="modal-drop-<%= $dbname %>" type="button">Escape</button>
            </p>
        </form>
        <button class="close-button" data-close="modal-drop-<%= $dbname %>" type="button">&times;</button>
    </div>

%#  --- rename database ---
    <div class="reveal" id="modal-rename-<%= $dbname %>" data-reveal>
        <div class="text-center">
            <h5>Rename database <%= $dbname %> on <%= $agent_hostname %> </h5>
        </div>
        <form accept-charset="UTF-8" action="/agent/db/rename" method="get" data-abide novalidate>
            <input type="hidden" name="agentid" value="<%= $agent_id %>" />
            <input type="hidden" name="dbname" value="<%= $dbname %>" />
            <label>New name
                <input type="text" name="newname" value="<%= $dbname %>" placeholder="new db name" required pattern="[a-zA-Z0-9\u00A0-\uD7FF\uF900-\uFDCF\uFDF0-\uFFEF]{3,64}"/>
                <span class="form-error">mandatory, 3 or more letter</span>
            </label>
            <p class="text-center">
                <button type="submit" class="button success">Accept</button>
                <button class="button" data-close="modal-rename-<%= $dbname %>" type="button">Escape</button>
            </p>
        </form>
        <button class="close-button" data-close="modal-rename-<%= $dbname %>" type="button">&times;</button>
    </div>

%#  --- copy database ---
    <div class="reveal" id="modal-copy-<%= $dbname %>" data-reveal>
        <div class="text-center">
            <h5>Copy database <%= $dbname %> on <%= $agent_hostname %> </h5>
        </div>
        <form accept-charset="UTF-8" action="/agent/db/copy" method="get" data-abide novalidate>
            <input type="hidden" name="agentid" value="<%= $agent_id %>" />
            <input type="hidden" name="dbname" value="<%= $dbname %>" />
            <label>Copy name
                <input type="text" name="newname" value="<%= $dbname %>_copy" placeholder="db name of copy" required pattern="[a-zA-Z0-9\u00A0-\uD7FF\uF900-\uFDCF\uFDF0-\uFFEF]{3,64}"/>
                <span class="form-error">mandatory, 3 or more letter</span>
            </label>
            <p class="text-center">
                <button type="submit" class="button success">Accept</button>
                <button class="button" data-close="modal-copy-<%= $dbname %>" type="button">Escape</button>
            </p>
        </form>
        <button class="close-button" data-close="modal-copy-<%= $dbname %>" type="button">&times;</button>
    </div>

%#  --- operation modal ---
    <div class="reveal" id="modal-<%= $dbname %>" data-reveal>
        <div class="text-center">
            <h5><i class="fi-database" style="font-size:1.3em;"></i>&nbsp;Database <%= $dbname %> on <%= $agent_hostname %> </h5>
            <div class="stacked-for-small button-group">
                <a class="button" href="#" data-open="modal-schedule-<%= $dbname %>"><i class="fi-plus" style="font-size:1.3em;"></i>&nbsp;ToPlan</a>
                <a class="button" href="#" data-open="modal-dump-<%= $dbname %>"><i class="fi-archive" style="font-size:1.3em;"></i>&nbsp;Dump</a>
                <a class="button" href="#" data-open="modal-rename-<%= $dbname %>"><i class="fi-pencil" style="font-size:1.3em;"></i>&nbsp;Rename</a>
                <a class="button" href="#" data-open="modal-copy-<%= $dbname %>"><i class="fi-page-copy" style="font-size:1.3em;"></i>&nbsp;Copy</a>
                <a class="button alert" href="#" data-open="modal-drop-<%= $dbname %>"><i class="fi-trash" style="font-size:1.3em;"></i>&nbsp;Drop</a>
            </div>
        </div>
        <button class="close-button" data-close="modal-<%= $dbname %>" type="button">&times;</button>
    </div>
%   $num++;
% }

<div class="text-center">
    <h5>
        Agent <%= $agent_hostname%> database list&nbsp;
        <a href="/agent/db/list?id=<%= $agent_id %>"><i class="fi-refresh" style="font-size:1.3rem;"></i></a>
    </h5>
</div>

<table id="table" class="display" >
    <thead>
      <tr>
        <td>#</td>
        <td>dbname</td>
        <td>size</td>
        <td>conn</td>
        <td>owner</td>
      </tr>
    </thead>
    <tbody>
% $num = 1;

% foreach my $db (@{$dbList}) {
%   my $dbname = $db->{'name'};
%   my $dbsize = $db->{'size'};
%   my $dbowner = $db->{'owner'};
%   my $numbackends = $db->{'numbackends'};
%   $numbackends = '' if ($numbackends == 0);
    <tr>
        <td><%= $num %></td>
        <td><a href="#" data-open="modal-<%= $dbname %>"><%= $dbname %></a></td>
        <td><%= $dbsize %></td>
        <td><%= $numbackends  %></td>
        <td><%= $dbowner %></td>
    </tr>
%   $num++;
% }
    </tbody>
</table>

<script>
$.extend(true, $.fn.dataTable.defaults, {
    "searching": true,
    "ordering": true,
    "language": {
        "search": "",
        "lengthMenu": "_MENU_",
    },

} );

$(document).ready(function() {
    $('#table').DataTable();
});
</script>

%#EOF
