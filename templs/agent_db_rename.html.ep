%#
%# $Id$
%#
% layout 'default';
% title 'Dumper';
% use Mojo::Util qw(dumper);
% use Mojo::JSON qw(j encode_json decode_json);

% use utf8;
% use strict;

% my $m = $self->app->model;

% my $dbname = $req->param('dbname') || undef;
% my $agent_id = $req->param('agentid') || undef;
% my $newname = $req->param('newname') || undef;

% my $agent_profile = $m->agentProfile($agent_id);

% my $agent_hostname = $agent_profile->{'hostname'} || '';
% my $agent_username = $agent_profile->{'username'} || 'undef';
% my $agent_password = $agent_profile->{'password'} || 'undef';

% my $job_id = $m->job_create;
% $m->job_update(
%     $job_id, 
%     type => 'dbrename',
%     sourceid => $agent_id,
%     destid => $agent_id
% );
% my $jobMagic = $m->job_profile($job_id)->{'magic'};

% my $ua = Mojo::UserAgent->new(max_redirects => 5);

% my $param = "dbname=$dbname";
% $param .= "&newname=$newname";

% my $tx = $ua->get("https://$agent_username:$agent_password\@$agent_hostname:3001/db/rename?$param");

% my $body;
% eval { $body = $tx->result->body };
% $body ||= '{"result":"mistake"}';
% my $res = decode_json($body);

% if ($res->{'result'} eq 'success') {
    <div class="callout success">
        Agent <%= $agent_hostname %> rename database <%= $dbname %> to <%= $newname %> as job <%= $job_id %>.
    </div>
%   $m->agent_db_update($agent_id);
%   $m->job_update($job_id, status => 'done', error => 'noerr', stop => $m->timestamp);
% }

% if ($res->{'result'} ne 'success') {
    <div class="callout alert">
        Agent <%= $agent_hostname %> cannot rename <%= $dbname %>. 
        Job <%= $job_id %> was cancel.
    </div>
%   $m->job_update($job_id, status => 'pushjob', error => 'pusherr', stop => $m->timestamp);
% }

<div class="text-center">
    <a class="button" href="/agent/db/list?id=<%= $agent_id %>">DBList</a>
</div>
%#EOF

